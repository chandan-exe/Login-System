<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Face Login System</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <header class="dashboard-header admin-header">
            <div class="header-left">
                <a href="/" class="logo-small">üîê Face Login</a>
                <span class="admin-badge">Admin</span>
            </div>
            <div class="header-right">
                <a href="/dashboard" class="btn btn-outline btn-sm">My Dashboard</a>
                <button id="logout-btn" class="btn btn-outline btn-sm">Logout</button>
            </div>
        </header>

        <main class="admin-main">
            <h1>üõ†Ô∏è Admin Panel</h1>

            <!-- Stats Cards -->
            <div class="admin-stats">
                <div class="stat-card primary">
                    <h3 id="total-users">-</h3>
                    <p>Total Users</p>
                </div>
                <div class="stat-card success">
                    <h3 id="active-sessions">-</h3>
                    <p>Active Sessions</p>
                </div>
                <div class="stat-card info">
                    <h3 id="today-logins">-</h3>
                    <p>Today's Logins</p>
                </div>
                <div class="stat-card warning">
                    <h3 id="failed-attempts">-</h3>
                    <p>Failed Attempts</p>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="users">üë• Users</button>
                <button class="tab-btn" data-tab="attendance">üìã Attendance</button>
                <button class="tab-btn" data-tab="attempts">üîí Login Attempts</button>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content active">
                <div class="section-header">
                    <h2>User Management</h2>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Face</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="attendance-tab" class="tab-content">
                <h2>Today's Attendance</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Login Time</th>
                                <th>Logout Time</th>
                                <th>Method</th>
                                <th>Liveness</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-admin-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Login Attempts Tab -->
            <div id="attempts-tab" class="tab-content">
                <h2>Recent Login Attempts</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="attempts-table"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            window.location.href = '/login';
        }

        async function fetchWithAuth(url, options = {}) {
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            return fetch(url, options);
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
            });
        });

        async function loadStats() {
            try {
                const response = await fetchWithAuth('/api/stats');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('total-users').textContent = data.stats.total_users;
                    document.getElementById('active-sessions').textContent = data.stats.active_sessions;
                    document.getElementById('today-logins').textContent = data.stats.today_logins;
                    document.getElementById('failed-attempts').textContent = data.stats.failed_attempts_today;
                }
            } catch (e) { console.error(e); }
        }

        async function loadUsers() {
            try {
                const response = await fetchWithAuth('/api/users');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('users-table').innerHTML = data.users.map(u => `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.email}</td>
                            <td><span class="badge badge-${u.role}">${u.role}</span></td>
                            <td>${u.has_face ? '‚úì' : '‚úó'}</td>
                            <td><span class="badge badge-${u.is_active ? 'active' : 'inactive'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id}, '${u.username}')" 
                                    ${u.id === user.id ? 'disabled' : ''}>Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadAttendance() {
            try {
                const response = await fetchWithAuth('/api/attendance/today');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('attendance-admin-table').innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${log.username}</td>
                            <td>${new Date(log.login_time).toLocaleTimeString()}</td>
                            <td>${log.logout_time ? new Date(log.logout_time).toLocaleTimeString() : '<span class="badge badge-active">Active</span>'}</td>
                            <td>${log.login_method}</td>
                            <td>${log.liveness_score ? log.liveness_score.toFixed(1) + '%' : '-'}</td>
                            <td>${log.face_confidence ? log.face_confidence.toFixed(1) + '%' : '-'}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="6">No attendance records today</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        async function loadAttempts() {
            try {
                const response = await fetchWithAuth('/api/login-attempts?limit=50');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('attempts-table').innerHTML = data.attempts.map(a => `
                        <tr class="${a.success ? '' : 'row-error'}">
                            <td>${new Date(a.timestamp).toLocaleString()}</td>
                            <td>${a.username || 'Unknown'}</td>
                            <td>${a.attempt_type}</td>
                            <td><span class="badge badge-${a.success ? 'success' : 'error'}">${a.success ? 'Success' : 'Failed'}</span></td>
                            <td>${a.failure_reason || '-'}</td>
                            <td>${a.ip_address || '-'}</td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id, username) {
            if (!confirm(`Delete user "${username}"?`)) return;
            try {
                const response = await fetchWithAuth(`/api/users/${id}`, { method: 'DELETE' });
                const data = await response.json();
                alert(data.message);
                if (data.success) loadUsers();
            } catch (e) { alert('Delete failed'); }
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try { await fetchWithAuth('/api/logout', { method: 'POST' }); } catch (e) { }
            localStorage.clear();
            window.location.href = '/login';
        });

        // Load all data
        loadStats();
        loadUsers();
        loadAttendance();
        loadAttempts();
    </script>
</body>

</html>